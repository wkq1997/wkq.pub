---
title: 云原生架构之Kubernetes
---
## 简介

### 什么是Kubernetes

Kubernetes（首字母为 k ，首字母与尾字母之间有 8 个字符、尾字母为 s ,所以简称为 k8s）是在 2015年发布 1.0 版本，标志着 k8s 的生产可用。短短两年后， k8s 已经完成了对各类容器平台的标准化统一，同年底，容器技术的先行者 Docker 公司也宣布在其企业版产品 Docker EE 中支持 k8s。目前，各主流云厂商均已推出 Kubernetes Service，容器生态统一到了  k8s 平台上，k8s 已然是容器平台的事实标准。



k8s目前算是托管云原生应用的默认的服务平台。



有了容器之后为什么还要使用 k8s 呢？因为真正的生产型应用会涉及到多个容器。这些容器必须跨多个服务器主机进行部署。再加上对容器安全性问题的考虑，因此部署起来会比较复杂。但 k8s 的出现有助于解决这些问题。k8s 可以提供运行多个容器所需的编排和管理功能，借助 k8s 平台，你可以构建跨多个容器的应用服务、跨集群调度、扩展这些容器，并长期持续管理这些容器的健康状况。



下面是一些常见的 k8s 相关的概念：

* Node，即节点，是组成 k8s 集群的物理机和虚拟机。k8s 其实并不对节点的生命周期进行管理，比如 k8s并不能自动的给自己添加节点，而是需要外部的服务或工具将新的节点安装部署好之后，注册到 k8s 集群中。节点的具体资源配置对于 k8s 来说是只读的，比如 k8s 不能动态的修改节点的内存或 CPU 等资源。
* Kubelet，在节点上运行的服务，算是 k8s 在节点上的 agent，跟节点上的容器运行时以及存储和网络打交道，负责创建和管理运行在节点上的容器。
* Pod，算是 k8s 里最重要的一个资源。k8s 里面没有容器这个具体的资源，取而代之的是 Pod，Pod 是组成 k8s 应用的最小单元。Pod里面可以包含一个或多个容器，这些容器部署在单个节点上共享同一个 IP 地址、IPC、主机名称及其它资源。
* Service，服务。正如其名，如果你希望在 k8s上运行的应用对外提供服务，就需要船舰一个 Service 资源（其实也可以创建另一个资源 Ingress）。Service 将业务提供的服务与业务本身运行的 Pod 隔离，这样无论 Pod 移动到集群中的那个节点上，都不影响业务对外暴露的服务。
* Deployment / StatefulSet / DaemonSet ，这些资源都是用来管理 Pod 的。在实际的应用部署中几乎不会直接创建 Pod，而是创建这些资源作为业务的载体，这些资源针对的是不同类型的应用。
* Persistent Volume Claim：也叫 PVC，是 k8s 中的存储资源，可以挂载给 Pod 使用。



:::tip 免费试用Kubernetes

* [Play with Kubernetes](https://labs.play-with-k8s.com/)

:::

### Kubernetes 跟云平台的关系

除了可以在云平台上创建 k8s 集群之外，其实 k8s 跟云平台之间还有着千丝万缕的关系。

要创建一套 k8s 集群，就需要先准备 k8s 的节点，要么是物理机，要么是虚拟机，在云平台上基本都是通过创建虚拟机作为 k8s 的节点，因为虚拟机的创建和维护成本要比物理机低很多，比如当集群资源紧张时，你可以随时调整虚拟机的资源配置，无论是横向扩展（添加节点）还是纵向扩展（升级配置）。

除此之外，k8s 集群的很多功能依赖于云平台的一些服务。比如要创建 Ingress 或者 Loadbalancer 类型的 Service，就需要云负载均衡服务；要创建PVS，需要云存储服务；为了保障 k8s 集群节点之间的通信，就需要虚拟网络服务。

所以，在 k8s 的架构中，有一个组件叫 cloud-controller-manager，就是专门处理 k8s 集群跟不同云平台之间的集成。我们熟悉的云平台像 AWS 、Azure、Google Cloud，阿里云等等都有自己的 cloud-controller-manager实现。

![61cd5d79094d238312410576](https://img.wkq.pub/hexo/61cd5d79094d238312410576.png)

### 如何更好的使用 kubernetes

1. 谁负责 k8s 平台的维护

   部署和管理一套 k8s 集群并非是一个简单的工作，虽然 k8s 已经将托管应用程序的复杂性转移到自己的内部设计中，但不会让这些问题凭空消失，你必须始终做好平台的维护工作。

   使用了云平台上的 k8s 集群服务，这其中一部分的工作又转移到了云平台，比如 k8s 集群的升级一直以来都是令人头疼的问题，因为集群的升级过程可能会影响上面运行的所有应用。如果使用了云平台的 k8s 集群服务，那么升级的事情就不需要你操心了，由平台提供的 API 可以一键完成升级。

   但你仍然需要负责一些事情。比如为了让应用在集群上最有效率的运行，还需要部署大量的附加组件，有些几乎人人都在使用，有些则比较小众，比如 nginx ingress controller、cert-manager 和 cluster-autoscaler等，这些额外组件的安装、配置、调优、监控以及升级等工作都需要负责。

2. 应用的监控 

   k8s 并不负责对用户业务进行监控和运维。你仍然需要考虑如何对自己的业务进行健康检查，手机监控指标以及如何设计和触发告警。

   对于自己维护的 k8s 集群来说，Prometheus 是目前在k8s 平台上使用比较广泛的监控告警软件。对于使用云平台的 k8s 集群服务创建的集群来说，云平台已经将集群上应用的监控和运维集成到了自身云平台的监控服务中，这样用户就可以在一个统一的方法中使用统一的方式来管理自己在云平台上的所有应用。

3. 无处不在的 operator

   自从 operator 的概念在 k8s 社区出现之后，目前几乎所有有状态的服务在 k8s 上都有了自己的 operator 实现，有些是开源的有些是商业的。使用 operator 固然极大方便了 k8s 上有状态应用的部署和管理，比如数据库集群，operator 屏蔽了一个软件的安装部署在底层的具体实现。

## Kubernetes应用部署方式 — Manifests

* kubectl apply -f PATH
* 万变不离其宗
* 管理成本高，复用率低

### Kubernetes应用部署方式 — Helm

* 类似 ubuntu apt .[Artifact Hub](https://artifacthub.io/)
* 交付 Kubernetes 应用
* 成也 values.yaml 败也 values.yaml
* 针对**定制化需求不高**的使用场景

## Kubernetes应用部署方式—Kustomize

* 回归 Manifests ，配置复用
* 典型场景：同一应用部署在不同环境
* 集成 `kubectl . kubectl apply -k <kustomization directory>/`
* 